# Multi Stage Docker Build

Multi Stage Docker Build is the technique to reduce the size of docker image by using multiple stages in the docker file.

```Multi Stage Docker Build, docker image के size को reduce करने की एक process है, जिसमे हम docker file के अंदर multiple stages का use करके docker image का size reduce करते हैं|```

<br>

### Problem before Multi Stage docker build

Jab hum ```Dockerfile``` likhte hain, toh usmein kuch steps hote hain:
- Ek base image choose karte hain.
- Code copy karte hain.
- Dependencies install karte hain.
- App ko run karte hain.

Example:
```
FROM python:3.11

WORKDIR /app

COPY . .

RUN pip install -r requirements.txt

CMD ["python", "app.py"]
```

Is docker file ko jab build kiya jayega to isse ek final image generate hogi jiska size Gbs main hoga. To hum nhi chate ki docker image ka size bhot jyada bada ho. Esa nhi hona chaiye.

Ye steps:
- Python Environment.
- Code.
- Libraries.
- Uneccessary Files.

Docker file ke steps unecessary chizo ko final image main le jate hain jisse image ka size increase ho jata hai, but app ko run karne ke liye runtime environment aur build artifact chaiye hote hain.

To ye problem hain single stage docker file main ki isse final image ka size badh jata hai kyuki final image main app ko build karne ke liye ko required chize hoti hain vo final image main aa jati hain.

<br>

### Concept of Multi-Stage Docker Build

A multi-stage build uses multiple ```FROM``` statements in one Dockerfile.

With a multi-stage build, you split your build process into multiple steps (called stages) — each with its own base image and purpose.

In a multi-stage build, you separate the process into stages:
- **Build stag**e: Build the app, install dependencies, run tests
- **Runtime stage**: Only copy final artifacts needed to run the app

Multi-stage build ek aisa Dockerfile structure hota hai jisme aap ek se zyada FROM instructions use kar sakte ho. Har FROM ek naya stage start karta hai. Aap ek stage se dusre stage mein artifacts (like binaries, compiled code) copy karke final image bana sakte ho.

```Multi-stage docker build मैं पहली stage मैं हम app को build कर लेते हैं और दूसरी stage मैं pehli stage का build artifact दूसरी stage मैं copy कर लेते हैं जिससे final image मैं runtime environment और artifact रहता है और image का size काम हो जाता है```

<br>

### Syntax of Multi-Stage Build

```
FROM <base-image> AS <stage-name>
# ... instructions

FROM <runtime-image>
COPY --from=<stage-name> <source-path> <destination-path>
# ... instructions
```

Explanation:
- ```FROM``` starts a new stage.
- ```AS <name>``` gives the alias name to the stage.
- ```COPY --from=<name>``` copies files from first stage to final stage.
- Only final artifacts are transferred into the final image.

<br>

### How to create it

**Plan the Stages**

You’ll need:

**Builder Stage**:
- Base image with build tools (Node.js, Go, Java SDK etc.).
- Install dependencies.
- Build the app.

**Final (Production) Stage**:
- Lightweight base image (like nginx, alpine, scratch, or distroless).
- Copy only the built files or binaries from the builder stage.
- Run the app.


Example:

```
FROM python:3.11 AS builder

WORKDIR /app

COPY requirement.txt /app

RUN pip install -r requirements.txt

FROM python:3.11-slim

COPY --from=builder /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/

COPY . /app

CMD ["python","run.py"]
```

**Yha hua kya?**

Phli stage main humne ek full python libraries aur packages wali image choose ki jisko hum builder stage naam de diya. Fir workdir select kiya jaha pe file copy hongi aur niche wali saari command wha run hongi. Ab humne code ko likhte time ek file banai thi ```requirements.txt``` jisme hum vo packages likhe the jo app ko run karne ke liye use honge. Usko hum work directty main daal diya. Fir humne un packages ko install kiya. Uske baad humari first stage end ho gyi kyuki humko us stage main app run nahi karna hota hai app run final stage main karna hota hai. Fir final stage banai jisme humne python ki slim image use ki, ye slim image itni light hai ki isme bus python ki file ko run karne ke liye environment hota hai. 

Uske baad humko builder stage main jo package install kiye the vo humko final stage main copy karne hain jisse app ko run kiya ja sake. Fir humne code ko final stage main copy kar liya aur fir app run kar diya.

Ab humne ye search kiya the ki python ke installed packages kha store hote hain vo location ko humne yha use kiya hai.

