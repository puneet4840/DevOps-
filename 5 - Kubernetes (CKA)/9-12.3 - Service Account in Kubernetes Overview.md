# Service Account in Kubernetes

Kubernetes me Service Account (SA) ek identity hai jo cluster ke andar chalne wale applications/pods ke liye hoti hai, jaise hum log ke liye normal user account hota hai, lekin pods ke liye service account hota hai.

Example:

```Jaie hum Azure main service principle create karte hain, agar humko third party application ko azure ke kisi resource ka access provide karna hai to hum ek service principle create karte hain aur, fir us service principle ko us resource ke iam main jake access dete hain aur third party application service principle ke credentials ka use karke access karta hai.```

```Vaise hi kubernetes main service account hota hai, Api Server pe access proivide karne ke liye. Isme bhi user, pods, CI/CD pipelines jaise resources ya application ko access provide karte h. Isme hum service account ko role, role bindind ke through access dete hain.```

- Normal users → Human DevOps Engineers (Puneet, etc.).
- Service accounts → Robot users (pods, controllers, automation jobs, CI/CD pipelines).

<br>

### Kyun chahiye Service Account?

Socho tumhare paas ek Pod hai jo:
- Apne namespace ke ConfigMap padhna chahta hai. ConfigMap ka data etcd main store hai aur etcd se data Api Server se request kakre access kiya ja sakta hai.
- Dusre pods ke status check karna chahta hai.
- Secrets ko access karna chahta hai.

Pod ke paas API Server ka URL to hoga (kubernetes.default.svc.cluster.local), lekin API Server pe request bhejne ke liye authentication & authorization chahiye.

Service Account ye authentication identity provide karta hai.


<br>

### Default Behavior

Kubernetes me har namespace me ek default service account hota hai:

Example:
```
kubectl get sa -n <namespace>
```

Output:
```
NAME      SECRETS   AGE
default   1         5d
```

- Agar tum Pod create karte waqt koi service account specify nahi karte → default service account use hota hai.
- Iska token Pod me automatically mount hota hai ```/var/run/secrets/kubernetes.io/serviceaccount/token``` path pe.

To by default pod is default service account ka use karta hai Api Server ko access karne ke liye, Api Server ko connect karne ke liye token ya certificate chaiye hota hai vo default service account ka token pod create hone par automatically pod main mount ho jata hai.

Isliye jab hum koi configMap ya image pull secret create karke pod ya deployment main mention karte hain to pod unko isi default service account ke throgh Api Server ko request karta hai aur Api Server etcd se vo information pod ko provide karta hai.


<br>

### Service Account ka Internal Structure

Jab tum ek service account banate ho:
- Kubernetes ek ServiceAccount object create karta hai.
- Ek Secret banata hai (jo token store karta hai).
- Secret me hota hai:
  - JWT token (authentication ke liye).
  - CA certificate (API Server ke TLS verify ke liye).
- Ye secret Pod ke andar mount ho jata hai.

<br>

### Example: Default Service Account ka Secret

Example:
```
kubectl get sa default -n default -o yaml
```

Output:
```
secrets:
- name: default-token-abcde
```

Secret detail:
```
kubectl get secret default-token-abcde -o yaml
```

Output:
```
type: kubernetes.io/service-account-token
data:
  ca.crt: LS0tLS1CRUdJTi...
  namespace: ZGVmYXVsdA==
  token: eyJhbGciOiJSUzI1...
```

<br>

### Service Account ka Flow – Pod ke andar

**Step 1: Pod Creation Time**:
- Tum ```kubectl apply -f pod.yaml``` karte ho.
- API Server request ko receive karta hai.
- Agar tumne pod ke spec main ```.spec.serviceAccountName``` me kuch nahi diya, to API Server automatically default service account pod ko assign karta hai (default namespace ka).
- Admission Controller ka ek type ServiceAccount hota hai jo ensure karta hai ki har pod ke paas ek valid service account linked ho.

<br>

**Step 2: Kubelet Mounts the Token**:
- Jab Kubelet Pod ko node par create karta hai:
  - Wo dekhta hai ki Pod kis service account ka use kar raha hai.
  - Kubelet Service Account ke credentials (token + CA cert) Pod ke andar volume mount karta hai.
  - Ye volume usually pod ke ander ```/var/run/secrets/kubernetes.io/serviceaccount``` path par hota hai.

- Pod ke andar files hoti hain:
  - token → JWT (JSON Web Token).
  - ca.crt → Cluster ka CA certificate (API server verify karne ke liye).
  - namespace → Pod ka namespace.
 
<br>

**Step 3: Application inside Pod Uses Token**:
- Pod ke andar chalne wala container jab Kubernetes API Server ko API call karega (for example: ```GET /api/v1/pods```), wo HTTP request me call karta hai:
  - Authorization Header me Bearer <token> add karega.
  - HTTPS ke through API server ka URL hit karega (```https://kubernetes.default.svc``` cluster DNS ka default endpoint hota hai API server ka).
  - API Server apna certificate bhejta hai client ko matlab container (application) ko.
  - Jab Api Server apna certificate TLS handshake ke time par application ko behjta hai to Application ```ca.crt``` use karke API server ka certificate verify karegi (TLS handshake me). 
    - Uper wali line ka basic idea ye hai.
    - Kubernetes API Server apne certificate ko ek Certificate Authority (CA) se sign karata hai.
    - Yeh CA Kubernetes cluster ka root CA hota hai.
    - Kubernetes har Pod ke andar ```/var/run/secrets/kubernetes.io/serviceaccount/ca.crt``` me root CA ka public certificate inject karta hai.
    - Application is CA certificate ko use karke check karti hai ki:
      - API Server ka certificate isi CA ne sign kiya hai ya nahi.
      - Certificate expire to nahi hua.
      - Domain name match ho raha hai ya nahi (jaise kubernetes.default.svc).

<br>

**Step 4: Access ho jata hai**:
- API Server token ko verify karta hai → uske saath mapped RBAC permissions check karta hai.
- Agar allow hua → request process hoti hai.

<br>
<br>

## Example Lab: Create Custom Service Account

Is example main hum dekhenge ki pod ko default service account na deke hum khud ka banya hua service account de sakte hain aur permission define kar sakte hai ki pod kya kya action perform kar sakta hai.

<br>

**Step-1: Create a custom Service Account**:

Sabse pehle kubernetes main ek service account banao.

Example:
```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-reader
  namespace: dev
```

Create:
```
kubectl apply -f sa.yaml
```

<br>

**Step 2: Service Account ko Permission dena (RBAC)**:

Service account to ban gya hai ab service account ko RBAC permission deni hai ki ye jis pod pod ko hum ye service account assign karenge to vo pod kya kya action is service account se Api Server par perform kar sakta hai.

By default, naya service account ke paas koi permission nahi hota. Tumhe RBAC role create karke bind karna padta hai.

To sabse pehle ek Role create karna hota hai jisme hum batate hain ki service account ko kya kya permission deni hai. Fir RoleBinding create karni padti hai jisme hum batate hain ki is particular service account ko is particular Role se attach ya bind karna hai.

Create Role:
```
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: dev
  name: pod-reader-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
```

Apply Role:
```
kubectl apply -f re.yaml
```

Create Role Binding:
```
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods-binding
  namespace: dev
subjects:
- kind: ServiceAccount
  name: pod-reader
  namespace: dev
roleRef:
  kind: Role
  name: pod-reader-role
  apiGroup: rbac.authorization.k8s.io
```

Apply RoleBinding:
```
kubectl apply -f rb.yaml
```

Yha tak humne service account ko role ke saath bind kar diya hai.

<br>

**Step 3: Pod me Service Account Use karna**:

Ab pod ke ander humko service account mention karna padega jisse pod default service account ko na use karke humara banaya hua service account use kare.

Example:
```
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  namespace: dev
spec:
  serviceAccountName: pod-reader
  containers:
  - name: myapp
    image: busybox
    command: ["sleep", "3600"]
```
Explanation:
- pod ke spec main service account mount kiya jata hai.
- Jab ye pod chalega, iske paas ```pod-reader``` service account ka token mounted hoga.
- Ab ye pod sirf pods list/get kar paayega dev namespace me.

Ab ye pod sirf mentioned permission hi perform kar payega, service account ka use ese kiya jata hai.

<br>
<br>

### Common Real-World Use Cases
- CI/CD pipelines (Jenkins, ArgoCD, GitLab runners) ko cluster access dena.
- Monitoring tools (Prometheus) ko API access dena.
- In-cluster operators/controllers (Ingress Controller, Cert-Manager).
- Cross-namespace automation jobs.

<br>

### Security Best Practices
- Default service account ko permissions mat do.
- Har application ke liye dedicated service account banao.
- Least privilege principle follow karo.
- Short-lived tokens use karo.

<br>

### Troubleshooting Tips
- Pod me kaunsa SA use ho raha hai?
```
kubectl get pod <name> -o jsonpath='{.spec.serviceAccountName}'
```

- SA ka token check karna:
```
kubectl describe sa <sa-name> -n <ns>
```

- SA ki RBAC permission check karna:
```
kubectl auth can-i get pods --as=system:serviceaccount:dev:pod-reader -n dev
```

