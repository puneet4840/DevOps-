# Deployment of application on Kubernetes cluster using service account in using CI/CD Pipeline

Azure DevOps ki CI/CD pipeline se Azure AKS (Kubernetes) par deployment karne ka scenario — isme Service Account, Service Connection, aur RBAC ka kaafi interesting combination hota hai.

```Maine apne ek project main dekha tha ki hum Azure DevOps ki CI/CD pipeline ka use karke AKS par application ko deploy karte the. Wha maine dekha tha ki pipeline main jis service connection ka use hua tha cluster se connect karne ke liye vo service account ka use hua tha. To is artile main dekhte hain ki service account ka use karke hum kubernetes par CI/CD pipeline se kaise deployement kar sakte hain.```

<br>

### Scenario Recap
- Tumhare paas Azure AKS cluster hai (Managed Kubernetes).
- Tum Azure DevOps pipeline use karke code deploy karte ho Kubernetes me.
- Pipeline me tumne Service Connection banaya tha Azure DevOps me.
- Kubernetes me tumne ek Service Account banaya tha jisse Azure DevOps ko access milta tha.

<br>

### Problem Statement – Ye sab kyun karna padta hai?

Jab Azure DevOps ka agent (jo tumhara pipeline chalata hai) AKS cluster me deploy karna chahta hai:
- Us agent ko Kubernetes API Server pe request bhejni hoti hai (like ```kubectl apply -f deployment.yaml```).
- API Server ke paas Authentication aur Authorization ka system hai (jaise humne pehle detail me padha).
- Agent ko identity proof dena padta hai (Authentication) aur permission chahiye (Authorization).

Yahi jagah aati hai Service Account + RBAC + Service Connection ki.

<br>

### High-Level Flow
```
Azure DevOps Pipeline Agent
       |
       v
Service Connection (Azure DevOps side)
       |
       v
Kubernetes API Server (AKS)
       |
       v
Service Account (K8s side)
       |
       v
RBAC Rules (Role / ClusterRole + RoleBinding / ClusterRoleBinding)
```

<br>

### Azure DevOps Service Connection ka Concept

Service Connection basically ek credential storage hai Azure DevOps me. Ye pipeline ko allow karta hai ki wo external systems (Azure AKS, AWS, GitHub, DockerHub, etc.) ke saath securely connect kar sake without tumhe har baar credentials manually dene ke.

Azure DevOps me Kubernetes ke liye 2 tarike ke Service Connections common hote hain:
- Azure Resource Manager (ARM) based Service Connection:
  - Ye Azure AD ka use karke AKS ke saath authenticate hota hai.
  - Isme tum Azure DevOps ko ek Azure Service Principal ka credential dete ho (App Registration in Azure AD).
  - Azure DevOps → Azure → AKS API → Kubernetes API Server → RBAC.
 
- Kubeconfig / Service Account Token based Service Connection:
  - Isme tum Azure DevOps ko kubeconfig file ya direct service account ka token dete ho.
  - Pipeline jab chalega, to ```kubectl``` commands me wo token use hoga authentication ke liye.
  - Ye method Azure AD ke bina kaam karta hai, direct Kubernetes ke Service Account ke through.

<br>

### Service Account Token ka High-Level Flow

- **Kubernetes me ek Service Account banate ho**:
  - ye ek special identity hoti hai jo pods, pipelines, ya automation scripts ke liye hoti hai.
- **RBAC Role / RoleBinding banate ho**:
  - ye define karta hai ki service account cluster me kya kar sakta hai (authorization part).
- **Service Account ka Token lete ho**:
  - ye ek JWT (JSON Web Token) hota hai jo kubernetes API server ko identity verify karne ke liye diya jata hai.
- **Token ko Azure DevOps Service Connection me store karte ho**:
  - taaki pipeline jab chale to wo token use karke cluster me login kare.
- **Pipeline run hone par API server ke saath TLS + Token based authentication hoti hai**:
  - API server token verify karke allow/deny karega.
 
<br>
<br>

## Step-by-Step Practical Example

**Step 1 — Service Account Create Karna**:

Sabse pehle tum aks ke ander ek service account create karo.

Example:
```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: devops-deployer
  namespace: default
```
- Isse default namespace me ek service account ban gaya jiska naam devops-deployer hai.

<br>

**Step 2 — Role Define Karna**:

Maan lo tum chahte ho ki yeh service account particular namespace main deployments aur services create/update/delete kar sake. To tumko is service account ko ek role create karke bind karna padega.

Example:
```
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: devops-deployer-role
rules:
- apiGroups: ["", "apps", "extensions"]
  resources: ["deployments", "services", "pods"]
  verbs: ["get", "list", "watch", "create", "update", "delete"]
```

<br>

**Step 3 — RoleBinding Create Karna**:

Ab is service account ko aur role ko apas main bind karenge jisse service account par permission attach ho sake.

Example:
```
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: devops-deployer-binding
  namespace: default
subjects:
- kind: ServiceAccount
  name: devops-deployer
  namespace: default
roleRef:
  kind: Role
  name: devops-deployer-role
  apiGroup: rbac.authorization.k8s.io
```

Ye binding service account ko role ke rights deta hai.

<br>

**Step 4 — Token Nikalna**:

Ab service account ke liye ek token create karna hai. Ye token authentication main help karega. Basically token hum isliye create karte hain kyuki client api server se authenticate kar sake.

Kubernetes v1.24+ me Service Account Token Secret auto-create nahi hota, tumhe manually create karna padta hai.

Example:
```
apiVersion: v1
kind: Secret
metadata:
  name: devops-deployer-token
  annotations:
    kubernetes.io/service-account.name: devops-deployer
type: kubernetes.io/service-account-token
```

Iske apply hone ke baad:
```
kubectl get secret devops-deployer-token -o jsonpath='{.data.token}' | base64 --decode
```

Ye tumhe ek JWT token dega (bahut lamba string).

<br>

**Step 5 — API Server ka URL nikalna**:

Api Server ka url ek to service account aur token ko test karne ke liye le rhe hain, dusra is api server ke url ko azure devops ke service connection main dena padega.

Example:
```
kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
```

Output:
```
https://aks-cluster-name-dns-xxxx.hcp.eastus.azmk8s.io:443
```

<br>

**Step 6 — Token Test Karna**:

Ab tum direct API call karke check kar sakte ho:

Example:
```
curl -k \
  -H "Authorization: Bearer <TOKEN>" \
  https://aks-cluster-name-dns-xxxx.hcp.eastus.azmk8s.io/api/v1/namespaces/default/pods
```

Agar token valid hai aur RBAC allow karta hai to tum pods list kar paoge.

<br>

**Step 7 — Azure DevOps Service Connection Setup**:

Ab azure devops main ek service connection banaoge jisko tum pipeline main deployment main use karoge.

- Azure DevOps → Project Settings → Service connections → New service connection.
- Select Kubernetes.
- Choose Service Account option.
- Fill:
  - Server URL: https://<AKS-API-SERVER-ENDPOINT>.
  - Bearer Token: (Step 3 ka token).
  - Namespace: dev.

- Save.

<br>

**Step 8 – Pipeline me Use Karna**

Azure DevOps pipeline example:
```
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Kubernetes@1
  displayName: 'Deploy to AKS'
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: 'aks-service-connection-name'
    command: 'apply'
    useConfigurationFile: true
    configuration: 'manifests/deployment.yaml'
```

<br>

### Background me Kya Hota Hai

Jab pipeline chalta hai:
- Azure DevOps agent Service Connection ke credentials load karta hai.
- Wo ```kubectl``` ko token pass karta hai:
  ```
    kubectl --server=https://<aks-endpoint> --token=<service-account-token> apply -f deployment.yaml
  ```
- Kubernetes API Server token verify karta hai:
   - Token → JWT → ```sub=system:serviceaccount:dev:azdo-deployer```.
- Authorization (RBAC) check hota hai:
   - RoleBinding ke through match → allow.
- Resource apply ho jata hai.


<br>
<br>
<br>

## CI/CD pipeline se kubernetes main pod deployment main service account ka token ko manually create kyu karna hota hai jabki pod main service account dene par token autmatically mount ho jata hai, esa kyu?

**Scenario**:

```Suppose maine ek service account banaya aur usko pod main mount kar diya, to is situation main service account ka token automatically create ho jata hai aur kubelet token ko pod ke ander mount kar deta hai.```

```But jab CI/CD pipeline ke through hum kubernetes main deployment karte hain to, pipeline ko deployement karne ke liye kubernetes ke api server ka access chaiye to uske liye hum kubernetes main ek service account banate hain aur uska token create karke pipeline main dete hain tab pipeline api server ko deployment ke liye access kar pati hai, Lekin yaha humne service account ke liye manaully token kyu create karna pada?```

<br>

### Dono Cases ko Samjho Side-by-Side

| Scenario                                                      | Token Creation                                                                                             | Token Lifetime                                            | Kaise Use Hota Hai                                                |
| ------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- | ----------------------------------------------------------------- |
| **Pod me Service Account assign**                             | Automatically kubelet mount karta hai token volume me                                                      | Short-lived (\~1h, auto-refresh via projected volume)     | Pod ke andar application API Server call kar sake                 |
| **Azure DevOps Service Connection me Service Account ka use** | Tumhe manually token banana padta hai (`kubectl create token` ya `ServiceAccount` + `Secret` create karke) | By default static (long-lived) unless tum expire set karo | Azure DevOps kubectl/helm CLI ko authenticate kar sake externally |


<br>

### Kyun Pod ke liye Token Automatically Banta Hai

