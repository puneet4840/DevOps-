# Custom User in Kubernetes

Jab hum AKS cluster par login karte hain, to hum azure portal par connect option par jake az cli ki command copy karke kubectl main paste karte hain aur aks cluster main login ho jata hai. Ye jo user hota hai ye Admin user ke through login karte hain hum.

Lekin agar ek developer hai usko cluster ke pods dekhne hain bss, to uske liye alag se ek custom user create karke devloper ko access de sakte hain.

<br>

### Background – AKS ka access model

AKS (Azure Kubernetes Service) ek managed Kubernetes cluster hai jo Azure ke control plane par chalta hai.

Kubernetes main access control do cheezon par depend karta hai:
- Authentication – Tum kaun ho? (Identity verification).
- Authorization – Tum kya kar sakte ho? (Permissions verification).

Aur Azure AKS me authentication mostly Azure Active Directory (AAD) ke through hota hai. Matlab tumhare paas ek Azure identity hoti hai (ya to Azure AD user ya Azure AD service principal / managed identity) jo cluster ke against authenticate hoti hai.

<br>

### Jab tum “Connect” button dabate ho Azure Portal me, matlab tum AKS se kubectl ke through kaise connect kar paate ho

**Scenario Example**:
- Maan lo tumhare paas ek AKS cluster hai:
  - Name: ```my-aks-cluster```.
  - Resource group: ```rg-demo```.
  - Azure subscription: ```xxxx-xxxx-xxxx```.
  - Tum Azure Portal me gaye → **Kubernetes services** → **my-aks-cluster** → **Connect** button pe click kiya.
  - Portal ne tumhe ye command di:
  ```
  az aks get-credentials --resource-group rg-demo --name my-aks-cluster
  ```

<br>

**Step 1: Ye command chalate hi kya hota hai**:

Ye uper di hui command ko tum apne local cmd main jaha kubectl install hai wha run karte ho.

**Azure CLI → Azure API**
- ```az aks get-credentials``` ek Azure CLI command hai jo internally Azure Resource Manager (ARM) API call karta hai.
- Ye call tumhare Azure login identity ke saath hota hai:
  - Agar tum Azure CLI me login ho (```az login``` se), to tumhare paas ek AAD access token hota hai.
  - Azure CLI ye token use karke ARM ko call karta hai:

  ```
  GET https://management.azure.com/subscriptions/<sub-id>/resourceGroups/rg-demo/providers/Microsoft.ContainerService/managedClusters/my-aks cluster/listClusterUserCredential?api-version=2023-04-01
  Authorization: Bearer <aad-access-token>
  ```

<br

**step 2: ARM API → AKS Control Plane**:
- Azure Resource Manager tumhara request verify karta hai (tumhare RBAC ke basis par — matlab tumhare Azure role "Azure Kubernetes Service Cluster User" ya "Admin" hona chahiye).
- Agar allowed ho, ARM tumhara request AKS control plane service ko forward karta hai.

<br>

**Step 3: AKS control plane → Kubeconfig generation**:
- AKS ke paas tumhare cluster ka API Server endpoint ka URL aur credentials kaise dene hain uska config hota hai.
- Tumne ```listClusterUserCredential``` ya ```listClusterAdminCredential``` call kiya hai (Azure CLI me --admin option hota hai admin credentials ke liye).
- AKS tumhare liye ek ```temporary kubeconfig``` banata hai:
  - Isme cluster ka server URL hota hai (public or private endpoint).
  - Isme ek Azure AD integration config hota hai ya ek client cert/token hota hai (depend karta hai tumhare AKS ka auth mode).
 
Example config jo Azure return karna hai (AAD enabled mode me):
```
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: <base64-ca-cert>
    server: https://my-aks-cluster-dns.hcp.eastus.azmk8s.io:443
  name: my-aks-cluster
contexts:
- context:
    cluster: my-aks-cluster
    user: clusterUser_rg-demo_my-aks-cluster
  name: my-aks-cluster
current-context: my-aks-cluster
kind: Config
users:
- name: clusterUser_rg-demo_my-aks-cluster
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      command: az
      args:
        - aks
        - get-credentials
        - --resource-group
        - rg-demo
        - --name
        - my-aks-cluster
        - --token-only
      installHint: Install Azure CLI

```

<br>

**Step 4: Local Machine → Kubeconfig Update**:

Tumhare local system main ek kubeconfig file hoti hai.

Azure CLI ye kubeconfig tumhare local ```~/.kube/config``` file me merge kar deta hai.

Ab tumhare paas ```kubectl``` ke liye cluster ka context ready hai.


<br>

**Step 5: Jab tum kubectl get pods chalate ho**:
- Tumhare kubeconfig me user ke liye ```exec``` block hota hai (Azure CLI call).
- ```kubectl``` jab request bhejne wala hota hai, wo ```exec``` plugin run karta hai — yaha pe ```az aks get-credentials --token-only``` hota hai.
- Azure CLI tumhare Azure login session ka use karke Azure AD token le aata hai (audience: ```6dae42f8-4368-4678-94ff-3960e28e3630``` jo Kubernetes API ke liye hota hai).
- Ye token ek OIDC/JWT access token hota hai jo AKS ke API server pe accept hota hai.

<br>

**Step 6: TLS Handshake + Bearer Token Auth**:
- Jab tum kubectl main koi bhi command likhte ho jaise ```kubectl get pods```, to kubectl API server ke saath TLS handshake karta hai.
- Server apna cert deta hai → client verify karta hai ```certificate-authority-data``` se.
- Yaha client certificate ka use nahi hota (kyunki tum Azure AD mode me ho).

- kubectl API server ko HTTP request bhejta hai:
```
GET /api/v1/namespaces/default/pods
Authorization: Bearer <aad-access-token>
```
- API Server ka OIDC Authenticator ye token Azure AD ke public keys se verify karta hai.
- API Server token se identity extract karta hai (AAD username, groups).
- RBAC rules check hote hain.
- Agar tumhe pods list karne ka permission hai → response return hota hai.

<br>

### Summary Flow Diagram
```
Azure CLI (az aks get-credentials)
       ↓
Azure Resource Manager (ARM)
       ↓
AKS Control Plane
       ↓
Returns kubeconfig (AAD/OIDC exec plugin)
       ↓
kubectl (exec plugin runs → gets fresh token)
       ↓
TLS handshake (server cert verify via CA)
       ↓
HTTP request with Bearer token
       ↓
K8s API Server (OIDC auth → RBAC check)
       ↓
Response to kubectl
```

<br>

### Key Points
- ```az aks get-credentials``` credentials generate nahi karta, bas kubeconfig fetch karta hai aks control plane se.
- Real authentication tab hota hai jab tum ```kubectl``` command chalate ho → tab Azure AD token liya jata hai.
- TLS handshake me sirf server verify hota hai, client cert nahi bhejta.
- Identity OIDC token me hoti hai, jo Azure AD sign karta hai.
- Azure DevOps pipeline ke case me tum manually Service Account token generate karke kubeconfig banaoge, kyunki CI/CD agent ke paas Azure CLI login nahi hota (ya tum AAD auth configure nahi karte).

