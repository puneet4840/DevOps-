# Automating IAC using Azue DevOps CI/CD Pipeline

We are going to create a CI/CD pipeline to automate the terraform Infrastructure as a Code. 

Aaj Hum Infrastructure as Code (IAC) Ko Azure DevOps CI/CD pipeline ke through automate karenge, iska matlab hai ki CI/CD pipeline ke through terraform ka use hoke infrastructure Azure cloud par create ho jaega. 

**Project URL**: https://dev.azure.com/puneet4840/Terraform%20with%20CICD

<br>
<br>

### Terraform without CI/CD kaise kaam karta hai

Terraform bina CI/CD ke normal use karne par kaise kaam karta hai, Ye terraform ka use kaise karte hain:

Sabse pehle hum terraform ki files ko create karte hain, jisme, ```main.tf```, ```providers.tf```, ```backend.tf```, ```terraform.tfvars```, ```variables.tf```. In files mein jo resource cloud pe create karna hai unki configuration likhi jati hai. Fir hum kuch commands run karte hain jisse cloud par resource create ho jate hain:

Commands Jaise:
- terraform init.
- terraform validate.
- terraform fmt.
- terraform plan.
- terraform apply.

In commands ko run karne ke baad cloud par resource create ho jata hai.

Explanation of these commands:

**Step-1: Terraform init**:
- Ye terraform se infrastructure create karne ka pehle step hota hai. ```terraform init``` command Terraform project ko initialize karta hai, jiske ander kaafi operations hote hain, Jaise:
  - Working directory taiyar karna.
  - Providers download karna.
  - Backend configure karna.
  - State management setup karna.
  - Modules ko download karna.

- Ye command ke baad terraform ready hota hai cloud par infrastructure create karne ke liye.

<br>

**Step-2: Terraform validate**
- ```terraform validate``` command terraform ki ```.tf``` files ke syntax ko check karti hai ki koi syntax error ya for koi structure issue to nhi hai. 

<br>

**Step-3: Terraform fmt**:
- ```terraform fmt``` command terraform ki ```.tf``` files ko format karta hai matlab files ke indentation aur spacing fix karta hai.

**Step-4: Terraform plan**:
- ```Terraform plan``` batata hai ki terraform configuration (jisko .tf file bolte hain) kya create, update aur destory karegi.
- Ye command pehle state file ko read karti hai ki state file ke according cloud mein kon konse resource bane hue hain, fir cloud se live resources ki details ko fetch karta hai ki kon konse resource bane hue hain. Fir tumhari terraform files ko check karta hai ki tum kon konse resource create karna chate ho, update karna chate ho ya delete karna chate ho.
- Is teeno ko compare karke tumko batata hai ki kya create hoga, kya update hoga, aur kya delete hoga.

<br>

**Step-3: Terraform Apply**:
- ```Terraform apply``` command terraform files mein likhi hui configuration ke according cloud mein resource create karta hai.

<br>
<br>

### Terraform CI/CD pipeline mein kaise kaam karta hai

Terraform ko CI/CD pipeline ke through automate karne ka ek flow hai, jo Azure DevOps ke through hum karenge.

<img src="https://drive.google.com/uc?export=view&id=1Dn9P0LTuFO9olJVK58uyaZ0tpQ8XEkVI" width="600" height="330">

<br>

Uper diagram ke according kya ho rha hai:
- Tumne terraform ki ```.tf``` files create ki apne local system par VS Code mein.
- Fir azure mein ek storage account create kiya aur uski detail ```backend.tf``` mein use ki.
- Fir ```.tf``` files ko git ke through Azure Repos mein push kar diya.
- Iske baad tumne Azure mein (CI) YAML Build pipeline create ki, Jisme ye steps use kiya:
  - Terraform install.
  - Terraform init.
  - Terraform validate.
  - Terraform fmt.
  - Terraform plan.
  - Archive files into Zip.
  - Publish artifacts.
 
- Ab Azure DevOps mein release pipeline create ki, jisme Apply stage aur Destroy stage create ki:
- Apply Stage:
  - Extract Zip files.
  - Terraform install.
  - Terraform init.
  - Terraform apply.

- Deploy stage mein approval use karna hai jo approval ke baad hi destroy stage run karega.
- Destroy Stage:
  - Extract Zip files.
  - Terraform install.
  - Terraform init.
  - Terraform Destroy.

<br>

**Step-1: Create Storage Account in Azure**:

Azure mein ek storage account create karna hai jo terraform backend ke liye use hoga:
- Create Storage Account.
- Create Blob Storage.
- Fir iski information ```backend.tf``` mein use karni hai.

<br>

**Step-2: Create Terraform tf files**:

Ab cloud par resource create karne ke liye apne local system mein VS Code ke through niche di gayi ```tf``` files banani hain:

```providers.tf```
```
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=4.1.0"
    }
  }
}

provider "azurerm" {
  resource_provider_registrations = "none" # This is only required when the User, Service Principal, or Identity running Terraform lacks the permissions to register Azure Resource Providers.
  features {}

}
```

```backend.tf```
```
terraform {
  backend "azurerm" {
    resource_group_name  = "learning"
    storage_account_name = "meraterraformbackend"
    container_name       = "terraform"
    key                  = "terraform.tfstate"
  }
}
```

```main.tf```:
```
resource "azurerm_resource_group" "rg" {
  name     = "my-rg"
  location = "West Europe"
}
```

```terraform.tfvars```:
```

```

```variables.tf```:
```

```

<br>

**Step-3 Push terraform files to Azure Repos using Git**:

Ab VS Code mein files ko commit karlo. Fir Azure Repos mein se repository ki url leke, local par git remote add karlo, jisse azure repos ki url tumhare local system mein as a remote add ho jayegi aur tum terraform files ko azure repos ki repository par push kar paoge.

<br>

**Step-4: Create CI Yaml pipeline**:

Ab tumko Azure DevOps mein CI Yaml pipeline create karni hai, Jiska code niche likha hai:

```
trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    steps:
    - task: TerraformInstaller@1
      displayName: Terraform Install
      inputs:
        terraformVersion: 'latest'
    
    - task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'Azure DevOps Pipeline connection with storage account using Terraform'
        backendAzureRmResourceGroupName: 'terraform'
        backendAzureRmStorageAccountName: 'meraterraformbackend'
        backendAzureRmContainerName: 'terraform'
        backendAzureRmKey: 'terraform.tfstate'

    - task: TerraformTask@5
      displayName: Terraform validate
      inputs:
        provider: 'azurerm'
        command: 'validate'
        
    - task: TerraformTask@5
      displayName: Terraform fmt
      inputs:
        provider: 'azurerm'
        command: 'custom'
        outputTo: 'console'
        customCommand: 'fmt'
        environmentServiceNameAzureRM: 'Pay-As-You-Go(65555fd5-5dc0-4bc0-a646-b01ddc552996)'

    - task: TerraformTask@5
      displayName: Terraform plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: 'Azure DevOps Pipeline connection with storage account using Terraform'

    - task: ArchiveFiles@2
      displayName: Archive Files
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
```

**Explanation of CI Yaml Pipeline**:

Yaml pipeline empty create karni hai aur usme ye yaml code use karna hai, Jisse starter pipeline create ho jayegi.

Starter Pipeline template:
```
trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    steps:
```

Ab iske niche tumko tasks add karne hain.

**Create Service Principle**:

Azure DevOps agent ko azure ke storage account se terraform.tfstate file ko read aur write karne ke liye tumko azure mein ek app registration create karna hai, fir azure devops portal mein app registration ki details ko use karke ek service principle create karne hai.

<br>

**Task-1: Terraform install**:

Pehle taks hoga terraform install karne ka. Jo Azure Devops ke agent par terraform tool install kar dega:

```
- task: TerraformInstaller@1
      displayName: Terraform Install
      inputs:
        terraformVersion: 'latest'
```

<br>

**Task-2: Terraform init**:

Ab pipeline mein tumko terraform init task run karvana hai, jo provider setup karega aur backend ko use karega. Is taks mein tumko storage account ki detail aur service connection ki detail deni hoti hai

```
- task: TerraformTask@5
      displayName: Terraform init
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'Azure DevOps Pipeline connection with storage account using Terraform'
        backendAzureRmResourceGroupName: 'terraform'
        backendAzureRmStorageAccountName: 'meraterraformbackend'
        backendAzureRmContainerName: 'terraform'
        backendAzureRmKey: 'terraform.tfstate'
```

<br>

**Task-3: Terraform Validate**:

Is task tumko terraform files ka validation karna hai matlab files ke syntax aur error ko check karna hai ki koi error to nhi hai.

```
- task: TerraformTask@5
      displayName: Terraform validate
      inputs:
        provider: 'azurerm'
        command: 'validate'
```

<br>

**Task-4: Terraform fmt**:

Is task mein tumko terraform files ko format karna hai matlab terraform files ka syntax aur spacing correct karna hai.

```
- task: TerraformTask@5
      displayName: Terraform fmt
      inputs:
        provider: 'azurerm'
        command: 'custom'
        outputTo: 'console'
        customCommand: 'fmt'
        environmentServiceNameAzureRM: 'Pay-As-You-Go(65555fd5-5dc0-4bc0-a646-b01ddc552996)'
```

<br>

**Task-5: Terraform plan**:

Is task mein tumko terraform plan run karna hai, jo ye batayega ki tumhari terraform files kya kya create, update aur delete karegi.

```
- task: TerraformTask@5
      displayName: Terraform plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: 'Azure DevOps Pipeline connection with storage account using Terraform'

```

<br>

**Task-6: Archive Files**:

Ab tumko apni terraform files ko zip mein convert karna hai, ye isliye kar rahe hain kyuki tum is files ko release pipeline mein extract karke as it is use kar sako. Kyuki apply stage aur destroy stage mein tumhare paas ye hi same files honi chaiye.

```
- task: ArchiveFiles@2
      displayName: Archive Files
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true
```

<br>

**Task-7: Publish Artifact**:

Ab tumko terraform files ko publish karna hai azure pipelines mein jisse tum in files ko use kar pao release pipeline mein.

<br>
<br>

### Create Release pipeline:

CI ke baad ab hamari CD pipeline chalti hai.

Ye pipeline responsible hai:
- Code extract karne ke liye.
- Terraform init chalane ke liye.
- Apply karne ke liye.
- Approval ke baad Destroy karne ke liye.

<img src="https://drive.google.com/uc?export=view&id=1h4eUvCgiGy1rPznmgcnybmeO4I4Kt_up" width="650" height="380">

<br>

**CD Pipeline Ka Detailed Flow (Apply Stage)**:

**Step 1: Artifact Download & Extract**:
- Yahan hum CI stage se aayi ZIP file ko download karte hain aur usko extract karte hain:
```
$(System.DefaultWorkingDirectory)/tf
```
Ye tumhara actual Terraform working directory ban jata hai.

<img src="https://drive.google.com/uc?export=view&id=1mH0R-6yxyOw-jo1Xiy4o9XrmCwBcdukg" width="650" height="380">

<br>

**Step 2: Terraform Install (Again)**:

CD stage me bhi Terraform install hota hai taaki:
- Environment clean ho.
- CI aur CD ka version match kare.

<br>

**Step 3: Terraform Init (Reconfigure Mode)**:

Hum ```-reconfigure``` use karte hain:
- Backend ko dobara forcefully configure karne ke liye
- Kyunki ye new agent hai, new directory hai
- Backend locking enable hoti hai jisse multiple pipeline runs conflict nahi karte.

<br>

**Step 4: Terraform Apply (Auto Approve)**:

Yahan hum run karte hain:
```
terraform apply --auto-approve
```

Iska matlab:
- Azure me saare resources automatically create ho jate hain
- VNet, VMs, subnets, public IPs â€” sab ban jate hain
- Koi manual approval nahi chahiye

Yahi point par IAC automation complete ho jata hai.

<br>

**Destroy Pipeline (Cleanup Stage)**:

Agar tumhe environment destroy karna ho to hum same flow follow karte hain:
- Artifact extract
- ```Terraform init```.
- ```terraform destroy --auto-approve```.

<img src="https://drive.google.com/uc?export=view&id=1VX2Yi8hImbRCN8PhPouJYZPkGAMoAbGh" width="650" height="380">

Isse poora infra safe tarike se delete ho jata hai.
