# Terraform Import Part-2

Azure me resources ka structure AWS se thoda complex hota hai kyuki Azure me har resource ka resource ID ek long URI format me hota hai.

Terraform import ka kaam yaha bhi same hai:
- “Jo resource Azure me already bana hua hai, usko Terraform ke state me register karna.”

<br>

### Before everything — Azure Resource ID Format

Azure me har resource ki ID kuch aise hoti hai:

```
/subscriptions/<SUB_ID>/resourceGroups/<RG_NAME>/providers/<PROVIDER>/<TYPE>/<NAME>
```

Example (Storage Account):
```
/subscriptions/84f8dabc-22ff-4c20-9c99-8123bae23aae/resourceGroups/myrg/providers/Microsoft.Storage/storageAccounts/mytestsa01
```

<br>

**Hune puchli slide mein storage account ko kaise import karte hain, ab dekhenge ki Azure VM ko kaise import karte hain**

<br>
<br>

## Example — Azure Virtual Machine Import — COMPLETE END-TO-END LAB

Azure VM import is complex because VM multiple dependent resources use karta hai:
- Network Interface
- Public IP
- OS Disk
- Network Security Group
- Availability Set (optional)

Terraform import ek command me multiple child resources ko nahi import karta. 

Tumhe har resource ko separately import karna hota hai.

<br>

**LAB GOAL**:

Azure me manually created VM environment ko terraform ke under lana.

<br>

**Existing Infra (Manually Created in Azure Portal)**:
- Resource Group — ```rg-import-demo```
- Virtual Network — ```vnet-app```
  - Address space: ```10.10.0.0/16```
- Subnet — ```subnet-web```
  - Prefix: ```10.10.1.0/24```
- Network Security Group (NSG) — ```nsg-web```
  - Rule: ```allow port 22```
- Public IP — ```pip-web01```
- Network Interface (NIC) — ```nic-web01```
- Virtual Machine — ```vm-web01```
  - Size: Standard_B2s
  - OS: Ubuntu LTS
- OS Managed Disk — auto-generated


Yeh sab resources already Azure portal se manually create kiye gaye hain.

Goal = Ye sab Terraform state me import karenge aur .tf files manually banayenge.

<br>

### LAB STRUCTURE
- Terraform project banana
- Empty resource blocks banana
- Azure Portal se resource IDs nikalna
- Sab resources ko ek-ek karke import karna
- Terraform plan me drift analyze karna
- Har resource ka proper terraform configuration likhna
- Final state = “No Changes”

<br>
<br>

### STEP 1 — Terraform Project Folder
```
mkdir azure-import-lab
cd azure-import-lab
```

<br>
<br>

### STEP 2 — provider block create

```provider.tf```
```
provider "azurerm" {
  features {}
}
```

<br>
<br>

### STEP 3 — Empty resource blocks create karo

**Note**:- IMPORT karne ke liye empty resource block hona compulsory hai. 

Aur resource block dependency ke according banane hain, jaise vm banane se pehle humko resource group create karna hota hai hai , to pehle resource blokc. Fir Vnet create karte hain to vnet block. Is tarike se dependency ke hisab se resource block banane hain.

```main.tf``` me ye likho:
```
resource "azurerm_resource_group" "rg" {}

resource "azurerm_virtual_network" "vnet" {}

resource "azurerm_subnet" "subnet" {}

resource "azurerm_network_security_group" "nsg" {}

resource "azurerm_public_ip" "pip" {}

resource "azurerm_network_interface" "nic" {}

resource "azurerm_managed_disk" "osdisk" {}

resource "azurerm_virtual_machine" "vm" {}
```

<br>
<br>

### STEP 4 — Terraform init
```
terraform init
```

<br>
<br>

### STEP 5 — Azure Portal Se Resource IDs Copy Karna

Ab azure portal se resources ki resource id ek-ek karke leke aani hai aur uspe import command chalani hai 

Azure me Resource ID milta hai:

Azure Portal → Resource → Properties → Resource ID

**Resource Group ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo
```

**VNet ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/virtualNetworks/vnet-app
```

**Subnet ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/virtualNetworks/vnet-app/subnets/subnet-web
```

**NSG ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/networkSecurityGroups/nsg-web
```

**Public IP ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/publicIPAddresses/pip-web01
```

**NIC ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/networkInterfaces/nic-web01
```

**OS Disk ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Compute/disks/vm-web01_OsDisk_1_xxx
```

**VM ID**:
```
/subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Compute/virtualMachines/vm-web01
```

<br>
<br>

### STEP 6 — IMPORT COMMANDS

Ab tumko import command chalani hai har resource ke liye dependency ke according, jisse terraform ki state file mein sabhi resource ki entry banti chali jaye.

⚠️ Order is important (dependency chain):

1️⃣ **Resource Group import**:
```
terraform import azurerm_resource_group.rg /subscriptions/<SUBID>/resourceGroups/rg-import-demo
```

2️⃣ **VNet import**:
```
terraform import azurerm_virtual_network.vnet /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/virtualNetworks/vnet-app
```

3️⃣ **Subnet import**:
```
terraform import azurerm_subnet.subnet /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/virtualNetworks/vnet-app/subnets/subnet-web
```

4️⃣ **NSG import**:
```
terraform import azurerm_network_security_group.nsg /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/networkSecurityGroups/nsg-web
```

5️⃣ **Public IP import**:
```
terraform import azurerm_public_ip.pip /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/publicIPAddresses/pip-web01
```

6️⃣ **NIC import**:
```
terraform import azurerm_network_interface.nic /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Network/networkInterfaces/nic-web01
```

7️⃣ **OS Disk import**:
```
terraform import azurerm_managed_disk.osdisk /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Compute/disks/vm-web01_OsDisk_1_xxx
```

8️⃣**VM import (last)**:
```
terraform import azurerm_virtual_machine.vm /subscriptions/<SUBID>/resourceGroups/rg-import-demo/providers/Microsoft.Compute/virtualMachines/vm-web01
```

<br>
<br>

### STEP 7 — Terraform Plan

```
terraform plan
```

Ab tumhe drift dikhai degi:
- Kayi properties missing.
- Storage OS disk config incomplete.
- NIC reference missing.
- NSG association missing. 
- Admin username mismatch (Azure doesn’t store password).
- VM size and publisher details missing.

Ye bilkul normal hai.

<br>
<br>

### STEP 8 — Write Full Terraform Configuration

Ab tumko empty resource block mein resources ki configuration likhni hai.

**1. Resource Group**:
```
resource "azurerm_resource_group" "rg" {
  name     = "rg-import-demo"
  location = "eastus"
}
```

**2. VNet**:
```
resource "azurerm_virtual_network" "vnet" {
  name                = "vnet-app"
  address_space       = ["10.10.0.0/16"]
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}
```

**3. Subnet**:
```
resource "azurerm_subnet" "subnet" {
  name                 = "subnet-web"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.vnet.name
  address_prefixes     = ["10.10.1.0/24"]
}
```

**4. NSG**:
```
resource "azurerm_network_security_group" "nsg" {
  name                = "nsg-web"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  security_rule {
    name                       = "allow-ssh"
    priority                   = 100
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_range     = "22"
    source_address_prefix      = "*"
    destination_address_prefix = "*"
  }
}
```

**5. Public IP**:
```
resource "azurerm_public_ip" "pip" {
  name                = "pip-web01"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  allocation_method   = "Static"
  sku                 = "Basic"
}
```

**6. NIC**:
```
resource "azurerm_network_interface" "nic" {
  name                = "nic-web01"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  ip_configuration {
    name                          = "ipconfig1"
    subnet_id                     = azurerm_subnet.subnet.id
    private_ip_address_allocation = "Dynamic"
    public_ip_address_id          = azurerm_public_ip.pip.id
  }
}
```

**7. OS Disk**:
```
resource "azurerm_managed_disk" "osdisk" {
  name                 = "vm-web01_OsDisk_1_xxx"
  location             = azurerm_resource_group.rg.location
  resource_group_name  = azurerm_resource_group.rg.name
  storage_account_type = "Premium_LRS"
  create_option        = "FromImage"
}
```

**8. VM**:
```
resource "azurerm_virtual_machine" "vm" {
  name                  = "vm-web01"
  location              = azurerm_resource_group.rg.location
  resource_group_name   = azurerm_resource_group.rg.name
  network_interface_ids = [azurerm_network_interface.nic.id]
  vm_size               = "Standard_B2s"

  storage_os_disk {
    name              = azurerm_managed_disk.osdisk.name
    create_option     = "FromImage"
    managed_disk_id   = azurerm_managed_disk.osdisk.id
  }

  storage_image_reference {
    publisher = "Canonical"
    offer     = "UbuntuServer"
    sku       = "18.04-LTS"
    version   = "latest"
  }

  os_profile {
    computer_name  = "vm-web01"
    admin_username = "azureuser"
  }

  os_profile_linux_config {
    disable_password_authentication = true
  }
}
```

<br>
<br>

### STEP 9 — Final Plan

```
terraform plan
```

Agar sab config file ki configuration Azure ke actual properties ke same ho, to tumko outout mein dikhega:
```
No changes. Infrastructure is up-to-date.
```

This means:
- Entire Azure env successfully imported.
- Terraform ab se complete infra manage karega.
- Environment fully IaC compliant ho gaya.

<br>
<br>

### LAB SUCCESSFULLY COMPLETED

Tumne complete Azure VM ecosystem — 7+ resources — ko import kiya:
- RG
- VNet
- Subnet
- NSG
- Public IP
- NIC
- Disk
- VM

Aur unhe Terraform ke state + configuration se align kiya.

Production level ka real import lab.

Yahi exactly companies me DevOps engineers karte hain when migrating to IaC.
